# GfW Comments Web Monetization Service

This project is a proof of concept of openDemocracy's Grant for Web-funded project to bring novel incentives to commenting via web monetization of the [Coral Talk](https://github.com/coralproject/talk) open source comments platform.

## Staging server

You can interact with the prototype by visiting:

https://comment-service.staging-caprover.opendemocracy.net/articles/some-article/

Where 'some-article' is a URL slug for an imaginary article on openDemocracy. Changing the slug will generate a new article.

## Communication from Coral Talk instance

A staging Coral Talk instance is running at https://coral-talk.staging-caprover.opendemocracy.net. 

### Webhook Events

This has been set to trigger the endpoint:

`/create-story`

whenever the "STORY_CREATED" event fires in Coral Talk. This happens every time the Coral Talk widget loads on a new page, so the event is fired every time you visit a variation on the URL above. `server.js` provides the endpoint and creates JSON files in `/public` for that story (using the URL slug as identifier).

### Moderation phase

Every comment posted to Coral is sent to `server.js` via a "Moderation phase" in the Coral Talk instance. This hits the `/highlight-comment` endpoint.

The service reads these comments and looks for identifiers sent in the comment body that it is being passed an author's web monetization wallet address, or a comment to highlight on the page. Comments that are used to pass messages are moderated as `status: 'REJECTED'` meaning they aren't shown as comments.

## Client-side JavaScript

Finally, this project provides a client side script for the page to embed which displays an interactive widget that guides commenters and page authors through their user journeys.

This file is stored in `views/client.js` and is served via the Nunjucks templating engine so we can insert the correct URL for it to look for the JSON files generated by the above endpoints.

## Running locally

Clone the project and `npm install`. Rename `.env.default` to `.env`. 

Run `npm run start` to start the server. If you want to work on the project productively you can run `npm run watch` and the server will reload.

You need to specify a Coral instance for it to interact with. It is best to be running a Coral instance locally. Follow [instructions for that on Trello](https://trello.com/c/baJNGrCW/60-ali-send-matt-his-local-od-version).

Once you have a local Coral instance, update `CORAL_ROOT_URL=http://localhost:3000` if it is running on a port other than 3000.

